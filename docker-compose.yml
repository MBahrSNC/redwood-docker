version: "3.8"

services:
  redwood-app:
    image: node:20-bookworm-slim
    container_name: redwood-app
    working_dir: /app
    volumes:
      - .:/app
    ports:
      - "8910:8910" # Redwood Web
      - "8911:8911" # Redwood API
      - "5555:5555" # Prisma Studio
      - "7910:7910" # Storybook
      - "4318:4318" # Redwood Studio
    environment:
      BROWSER: "none"
      NODE_ENV: ${NODE_ENV:-development} # Default to development if not set
    entrypoint: |
      bash -c "
      apt-get update && apt-get install -y openssl libssl3 ca-certificates &&
      echo 'y\n' | corepack enable &&
      if [ \"$NODE_ENV\" = \"production\" ]; then
        yarn install &&
        if [ ! -f /app/prisma/schema.prisma ]; then
          echo 'Prisma schema not found. Skipping prisma generate.';
        else
          npx prisma generate --schema=/app/prisma/schema.prisma;
        fi &&
        yarn rw build &&
        yarn rw serve;
      else
        if [ ! -f /app/redwood.toml ]; then
          echo '{\"private\": true}' > /app/package.json &&
          echo 'n\n' | yarn create redwood-app . --force --no-typescript --overwrite;
        fi &&
        yarn install &&
        rm -rf node_modules/.prisma &&
        npx prisma generate &&
        yarn rw dev;
      fi
      "
    restart: unless-stopped

volumes:
  redwood-data:
